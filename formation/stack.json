{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "c564a3a4-6892-44ce-b147-125a225bd011": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 340,
                    "y": 10
                },
                "z": 0,
                "embeds": [],
                "dependson": [
                    "31c64eb2-a22a-4f39-89e8-8149003f750c"
                ]
            },
            "09c44c6c-5566-4dd4-a91c-6a872e0ea03e": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 300,
                    "y": 330
                },
                "z": 0,
                "embeds": [],
                "isassociatedwith": [
                    "4f05693d-f3e3-4905-84cb-6ec35fd11c82"
                ],
                "dependson": [
                    "28dd2f7d-0608-4534-9696-93981074c94f"
                ]
            },
            "a62de25c-78aa-4666-9eb0-94abdb5f6d61": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 450,
                    "y": 470
                },
                "z": 0,
                "embeds": []
            },
            "31c64eb2-a22a-4f39-89e8-8149003f750c": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 440,
                    "y": -100
                },
                "z": 0,
                "embeds": []
            },
            "4c2bdb35-f695-4401-97c0-1956e808a89c": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 160,
                    "y": -50
                },
                "z": 0,
                "embeds": []
            },
            "e5e108ff-95df-40b5-ba29-56103e7954e3": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 190,
                    "y": 240
                },
                "z": 0,
                "embeds": []
            },
            "4f05693d-f3e3-4905-84cb-6ec35fd11c82": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 440,
                    "y": 250
                },
                "z": 0,
                "embeds": []
            },
            "28dd2f7d-0608-4534-9696-93981074c94f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 30,
                    "y": 410
                },
                "z": 0,
                "embeds": [],
                "isassociatedwith": [
                    "09c44c6c-5566-4dd4-a91c-6a872e0ea03e"
                ]
            },
            "b11be761-399e-4a4e-80a7-00d23c135558": {
                "source": {
                    "id": "a62de25c-78aa-4666-9eb0-94abdb5f6d61"
                },
                "target": {
                    "id": "09c44c6c-5566-4dd4-a91c-6a872e0ea03e"
                },
                "z": 0
            }
        }
    },
    "Resources": {
        "Distribution": {
            "Type": "AWS::CloudFront::Distribution",
            "Properties": {
                "DistributionConfig": {
                    "Aliases": [
                        {
                            "Fn::Join": [
                                ".",
                                [
                                    {
                                        "Ref": "ScopeName"
                                    },
                                    {
                                        "Ref": "ApexDomainName"
                                    }
                                ]
                            ]
                        }
                    ],
                    "CacheBehaviors": [
                        {
                            "PathPattern": "listing/*",
                            "AllowedMethods": [
                                "GET",
                                "HEAD"
                            ],
                            "DefaultTTL": 900,
                            "MaxTTL": 900,
                            "MinTTL": 900,
                            "ForwardedValues": {
                                "QueryString": true,
                                "Headers": [
                                    "Host"
                                ]
                            },
                            "TargetOriginId": "BackendStaticOrigin",
                            "ViewerProtocolPolicy": "redirect-to-https",
                            "Compress": true
                        }
                    ],
                    "Comment": {
                        "Ref": "AWS::StackName"
                    },
                    "DefaultCacheBehavior": {
                        "AllowedMethods": [
                            "GET",
                            "HEAD"
                        ],
                        "DefaultTTL": 0,
                        "MaxTTL": 0,
                        "MinTTL": 0,
                        "ForwardedValues": {
                            "QueryString": true,
                            "Headers": [
                                "*"
                            ],
                            "Cookies": {
                                "Forward": "all"
                            }
                        },
                        "TargetOriginId": "PublicBucketOrigin",
                        "ViewerProtocolPolicy": "redirect-to-https",
                        "Compress": true
                    },
                    "Enabled": true,
                    "Origins": [
                        {
                            "DomainName": {
                                "Fn::Select": [
                                    1,
                                    {
                                        "Fn::Split": [
                                            "//",
                                            {
                                                "Fn::GetAtt": [
                                                    "PublicBucket",
                                                    "WebsiteURL"
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            "Id": "PublicBucketOrigin",
                            "CustomOriginConfig": {
                                "OriginProtocolPolicy": "https-only"
                            }
                        },
                        {
                            "DomainName": {
                                "Fn::Join": [
                                    ".",
                                    [
                                        {
                                            "Fn::Join": [
                                                "-",
                                                [
                                                    {
                                                        "Ref": "ScopeName"
                                                    },
                                                    "api"
                                                ]
                                            ]
                                        },
                                        {
                                            "Ref": "ApexDomainName"
                                        }
                                    ]
                                ]
                            },
                            "Id": "BackendStaticOrigin",
                            "CustomOriginConfig": {
                                "OriginProtocolPolicy": "https-only"
                            }
                        }
                    ],
                    "PriceClass": "PriceClass_100",
                    "ViewerCertificate": {
                        "AcmCertificateArn": {
                            "Ref": "AcmCertificate"
                        },
                        "SslSupportMethod": "sni-only",
                        "MinimumProtocolVersion": "TLSv1"
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c564a3a4-6892-44ce-b147-125a225bd011"
                }
            },
            "DependsOn": [
                "PublicBucket"
            ]
        },
        "BackendInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": "ami-0d5eff06f840b45e9",
                "InstanceType": "t2.micro",
                "KeyName": "default",
                "SecurityGroups": [
                    {
                        "Ref": "BackendInstanceSecurityGroup"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "09c44c6c-5566-4dd4-a91c-6a872e0ea03e"
                }
            }
        },
        "DataVolume": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "Size": "8",
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "BackendInstance",
                        "AvailabilityZone"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a62de25c-78aa-4666-9eb0-94abdb5f6d61"
                }
            }
        },
        "DataMountpoint": {
            "Type": "AWS::EC2::VolumeAttachment",
            "Properties": {
                "InstanceId": {
                    "Ref": "BackendInstance"
                },
                "VolumeId": {
                    "Ref": "DataVolume"
                },
                "Device": "/dev/sdh"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b11be761-399e-4a4e-80a7-00d23c135558"
                }
            }
        },
        "PublicBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Join": [
                        ".",
                        [
                            {
                                "Ref": "ScopeName"
                            },
                            {
                                "Ref": "ApexDomainName"
                            }
                        ]
                    ]
                },
                "AccessControl": "PublicRead",
                "WebsiteConfiguration": {
                    "IndexDocument": "index.html",
                    "ErrorDocument": "404.html"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "31c64eb2-a22a-4f39-89e8-8149003f750c"
                }
            }
        },
        "CdnRoute": {
            "Type": "AWS::Route53::RecordSet",
            "Properties": {
                "HostedZoneId": {
                    "Ref": "HostedZoneId"
                },
                "Name": {
                    "Fn::Join": [
                        ".",
                        [
                            {
                                "Ref": "ScopeName"
                            },
                            {
                                "Ref": "ApexDomainName"
                            }
                        ]
                    ]
                },
                "AliasTarget": {
                    "HostedZoneId": "Z2FDTNDATAQYW2",
                    "DNSName": {
                        "Fn::GetAtt": [
                            "Distribution",
                            "DomainName"
                        ]
                    }
                },
                "Type": "A"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "4c2bdb35-f695-4401-97c0-1956e808a89c"
                }
            }
        },
        "ApiRoute": {
            "Type": "AWS::Route53::RecordSet",
            "Properties": {
                "HostedZoneId": {
                    "Ref": "HostedZoneId"
                },
                "Name": {
                    "Fn::Join": [
                        ".",
                        [
                            {
                                "Fn::Join": [
                                    "-",
                                    [
                                        {
                                            "Ref": "ScopeName"
                                        },
                                        "api"
                                    ]
                                ]
                            },
                            {
                                "Ref": "ApexDomainName"
                            }
                        ]
                    ]
                },
                "TTL": "300",
                "Type": "A",
                "ResourceRecords": [
                    {
                        "Fn::GetAtt": [
                            "BackendInstance",
                            "PublicIp"
                        ]
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e5e108ff-95df-40b5-ba29-56103e7954e3"
                }
            }
        },
        "BackendInstanceSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Join": [
                        "-",
                        [
                            "backend-security-group",
                            {
                                "Ref": "ScopeName"
                            }
                        ]
                    ]
                },
                "GroupDescription": "Allow HTTP/HTTPS and SSH inbound and outbound traffic",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "4f05693d-f3e3-4905-84cb-6ec35fd11c82"
                }
            }
        },
        "BackendPublicIP": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc",
                "InstanceId": {
                    "Ref": "BackendInstance"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    "webapp-eip",
                                    {
                                        "Ref": "ScopeName"
                                    }
                                ]
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "28dd2f7d-0608-4534-9696-93981074c94f"
                }
            }
        }
    },
    "Parameters": {
        "ScopeName": {
            "Description": "Name of the current scope (<<ScopeName>>.ua-wck.com)",
            "Type": "String"
        },
        "ApexDomainName": {
            "Description": "Apex domain (always ua-wck.com)",
            "Type": "String"
        },
        "AcmCertificate": {
            "AllowedPattern": "^$|(arn:aws:acm:)([a-z0-9/:-])*([a-z0-9])$",
            "Description": "[ Optional ] The AWS Certification Manager certificate ARN for the CloudFront distribution certificate - this certificate should be created in the us-east-1 (N. Virginia) region and must reference the WordPress domain name you use below.",
            "Type": "String"
        },
        "HostedZoneId": {
            "Description": "Hosted Zone ID for ua-wck.com",
            "Type": "String"
        }
    }
}